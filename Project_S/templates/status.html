<!DOCTYPE html>
<html>
<head>
    <title>PARKING</title>
    <style>
        .led { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-left: 10px; vertical-align: middle; }
        .btn { padding: 5px 10px; margin-left: 10px; }
        ul { list-style-type: none; padding: 0; }
        li { margin-bottom: 10px; }
    </style>
    <script>
        async function fetchStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            const list = document.getElementById('status');
            list.innerHTML = '';
            const user = "{{ username }}";

            for (const d in data.status) {
                const s = data.status[d];
                const r = data.reservations[d];
                const o = data.reservation_owners[d];

                let color = 'green';
                let label = 'Empty';

                if (s === 4) { color = 'blue'; label = 'Reported'; }
                else if (s === 3) { color = 'gray'; label = 'Sensor Error'; }
                else if (s === 1) { color = 'red'; label = 'Occupied'; }
                else if (r) { color = 'yellow'; label = 'Reserved'; }

                const li = document.createElement('li');
                li.innerHTML = `Spot ${d}
                    <span class="led" style="background:${color}"></span>
                    ${label}
                    ${(!r && s === 0) ? `<button class="btn" onclick="reserve('${d}')">Reserve</button>` : ''}
                    ${(r && s === 1 && o === user) ? `
                        <button class="btn" onclick="complete('${d}')">Confirm</button>
                        <button class="btn" onclick="report('${d}')">Report</button>` : ''}`;
                list.appendChild(li);
            }
        }

        function reserve(id){ fetch('/reserve/'+id,{method:'POST'}).then(fetchStatus); }
        function complete(id){ fetch('/complete/'+id,{method:'POST'}).then(fetchStatus); }
        function report(id){ fetch('/report/'+id,{method:'POST'}).then(fetchStatus); }

        setInterval(fetchStatus, 3000);
        window.onload = fetchStatus;
    </script>
</head>
<body>
    <h2>Parking Status</h2>
    <ul id="status"></ul>
</body>
</html>
