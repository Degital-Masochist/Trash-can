<!DOCTYPE html>
<html>
<head>
    <title>PARKING</title>
    <style>
        .led {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
            border: 2px solid #333;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
        }
        .green { background-color: #4CAF50; }
        .blue { background-color: #2196F3; }
        .red { background-color: #f44336; }
        .off { background-color: #555; }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .blue_blink {
            background-color: #2196F3;
            animation: blink 1s infinite;
        }
        .red_blink {
            background-color: #f44336;
            animation: blink 0.8s infinite;
        }
        .btn {
            padding: 6px 12px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .reserve-btn { background-color: #4CAF50; color: white; }
        .complete-btn { background-color: #2196F3; color: white; }
        .report-btn { background-color: #f44336; color: white; }
        .parking-container { 
            text-align: center; 
            margin: 20px 0; 
        }
        .parking-container img {
            max-width: 50%;
            height: auto;
            width: 100%;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .status-list {
            width: 700px;
            margin: 0 auto;
            font-family: Arial, sans-serif;
        }
        ul { list-style-type: none; padding: 0; }
        li {
            padding: 12px;
            margin-bottom: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 700px;
            margin: 20px auto;
        }
        #logout-btn {
            padding: 8px 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .user-info { text-align: center; margin: 10px 0; color: #555; }
    </style>
    <script>
        let reservationTimers = {};

        async function fetchStatus() {
            const response = await fetch('/api/status');
            const data = await response.json();
            const statusList = document.getElementById('status-list');
            statusList.innerHTML = '';
            reservationTimers = data.timers || {};
            const owners = data.reservation_owners || {};
            const illegal = data.illegal || {};
            const currentUser = "{{ username }}";
            const userBanned = data.ban_user;

            for (const device in data.status) {
                const signal = data.status[device];
                const reserved = data.reservations[device] || false;
                const remaining = reservationTimers[device] || 0;
                const owner = owners[device] || '';
                const isIllegal = illegal[device] || false;

                let ledClass = 'green';
                let label = 'Empty';

                if (signal === 3) {
                    ledClass = 'blue_blink';
                    label = 'Sensor Error';
                } else if (isIllegal) {
                    ledClass = 'red_blink';
                    label = 'Illegal Parking';
                } else if (signal === 1) {
                    ledClass = 'red';
                    label = 'Occupied';
                } else if (reserved) {
                    ledClass = 'blue';
                    label = 'Reserved';
                } else {
                    ledClass = 'green';
                    label = 'Empty';
                }

                let timer = '';
                if (reserved && remaining > 0 && owner === currentUser && !isIllegal) {
                    timer = `<span id="timer-${device}"></span>`;
                }

                // 예약 버튼 조건: 예약 안 됨 + 주차중 아님 + 센서 에러 아님 + 밴 아님
                const canReserve = !reserved && signal !== 1 && signal !== 3 && !userBanned;
                const canComplete = reserved && signal === 1 && owner === currentUser && !isIllegal;
                const canReport = reserved && signal === 1 && owner === currentUser && !isIllegal;

                const li = document.createElement('li');
                li.innerHTML = `
                    Spot No.${device}:
                    <span class="led ${ledClass}"></span>
                    <strong>${label}</strong>
                    ${timer}
                    ${canReserve ? `<button class="btn reserve-btn" onclick="reserve('${device}')">Reserve</button>` : ''}
                    ${canComplete ? `<button class="btn complete-btn" onclick="complete('${device}')">Confirm Parking</button>` : ''}
                    ${canReport ? `<button class="btn report-btn" onclick="report('${device}')">Report Illegal</button>` : ''}
                `;
                statusList.appendChild(li);
            }
        }

        function reserve(deviceId) {
            if (confirm("Do you want to reserve this spot?")) {
                fetch('/reserve/' + deviceId, { method: 'POST' }).then(() => fetchStatus());
            }
        }

        function complete(deviceId) {
            if (confirm("Mark parking as complete?")) {
                fetch('/complete/' + deviceId, { method: 'POST' }).then(() => fetchStatus());
            }
        }

        function report(deviceId) {
            if (confirm("Report illegal parking?")) {
                fetch('/report/' + deviceId, { method: 'POST' }).then(() => fetchStatus());
            }
        }

        function logout() {
            window.location.href = '/logout';
        }

        function updateTimers() {
            for (const device in reservationTimers) {
                if (reservationTimers[device] > 0) {
                    reservationTimers[device] -= 1;
                    const t = reservationTimers[device];
                    const minutes = Math.floor(t / 60);
                    const seconds = t % 60;
                    const el = document.getElementById(`timer-${device}`);
                    if (el) {
                        el.textContent = ` (left: ${minutes}m ${seconds}s)`;
                    }
                }
            }
        }

        setInterval(updateTimers, 1000);
        setInterval(fetchStatus, 3000);
        window.onload = fetchStatus;
    </script>
</head>
<body>
    <div id="header">
        <div>Logged in as: <strong>{{ username }}</strong></div>
        <button id="logout-btn" onclick="logout()">Logout</button>
    </div>

    <h1 style="text-align: center;">Parking Status Dashboard</h1>

    <div class="parking-container">
        <img src="/static/park.jpg" alt="Parking Lot">
    </div>

    <div class="status-list">
        <ul id="status-list"></ul>
    </div>
</body>
</html>